<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat room</title>
  </head>
  <body>
    <div id="chat-container">
      <div id="messages"></div>
      <form id="message-form">
        <input
          type="text"
          id="message-input"
          placeholder="enter message"
          required
        />
        <button type="submit">Send</button>
      </form>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const room = new URLSearchParams(window.location.search).get("room");
      socket.emit("joinRoom", { room });
      // Fetch previous messages
      fetch(`/chat/${room}`)
        .then((response) => response.json())
        .then((messages) => {
          messages.forEach((message) => {
            const div = document.createElement("div");
            div.textContent = message.content;
            document.getElementById("messages").appendChild(div);
          });
        });

      document
        .getElementById("message-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const msg = document.getElementById("message-input").value;
          console.log(msg);
          if (msg) {
            socket.emit("chatMessage", { msg, room });
          }
          document.getElementById("message-input").value = "";
        });
      socket.on("message", function (msg) {
        console.log(`${msg} this`);
        const div = document.createElement("div");
        div.textContent = msg;
        document.getElementById("messages").appendChild(div);
        window.scrollTo(0, document.body.scrollHeight);
      });
    </script>
  </body>
</html>
